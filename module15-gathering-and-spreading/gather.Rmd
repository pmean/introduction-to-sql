---
title: "Gathering and spreading"
author: "Suman Sahil, Steve Simon"
date: "Creation date: 2019-11-20"
output: powerpoint_presentation
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
suppressMessages(suppressWarnings(library(knitr)))
suppressMessages(suppressWarnings(library(magrittr)))
suppressMessages(suppressWarnings(library(sqldf)))
```

```{r connect}
db <- dbConnect(SQLite(), dbname="../data/lomaprie_db.sqlite")
```

### Description of lomaprie data set

![Description of data](../images/lomaprie.png)

<div class="notes">

This data set displays depression scores among college students in a study planned for other purposes but which ended up with the baseline measurements collected just before a major California earthquake. The researchers seized the opportunity to assess changes in depression immediately before and after the earchquake as well as the recovery process longer term.

The source for this data set is

http://www.statsci.org/data/general/lomaprie.html

</div>

### lomaprie_db, listing of original table

```{r}
sql_code1 <- 
"select *
  from earthquake_table
  limit 5"  
sql_code2 <- 
"select count(*) as n_records
   from earthquake_table"
```

+ SQL code
```
`r sql_code1`

`r sql_code2`
```

### lomaprie_db, listing of original table
+ Output
```{r}
dbGetQuery(conn=db, sql_code1)
dbGetQuery(conn=db, sql_code2)
```

<div class="notes">

This is what the original data looks like. Notice that there is no primary key in this table. Normally this is a major flaw in any reasonable database, but let's ignore that for now.

</div>

### Gathering into a single column

```{r}
sql_code1 <- 
"select 
  id, week0 as depression_score, 0 as time
  from earthquake_table
union select
  id, week3 as depression_score, 3 as time
  from earthquake_table
union select
  id, week6 as depression_score, 6 as time
  from earthquake_table"
```

+ SQL code
```
`r sql_code1`
```

### Gathering

```{r}
sql_code2 <- 
"union select
  id, week9 as depression_score, 9 as time
  from earthquake_table
union 
  select id, week12 as depression_score, 12 as time
  from earthquake_table
limit 13"
```
+ SQL code, continued
```
`r sql_code2`
```

<div class="notes">



</div>

### Gathering
+ Output
```{r}
dbGetQuery(conn=db, 
  paste(sql_code1, sql_code2, sep="\n"))
```

<div class="notes">



</div>

```{r disconnect-and-reconnect}
dbDisconnect(db)
db <- dbConnect(SQLite(), dbname="../data/cholestg_1_db.sqlite")
```

### Description of cholestg data set

![Description of data](../images/cholestg.png)

<div class="notes">

This data set shows cholesterol levels for patients after a heart attack. I simplified the data by removing the control patients.

The source for this data set is

[STatSci.org](http://www.statsci.org/data/general/cholest.html)

</div>

### cholestg_1_db, listing of original table

```{r}
sql_code1 <- 
"select *
  from ch_table
  order by patient, day
  limit 10
"
sql_code2 <- 
"select count(*) as n_records
   from ch_table"
```

+ SQL code
```
`r sql_code1`

`r sql_code2`
```

### cholestg_1_db, listing of original table
+ Output
```{r}
dbGetQuery(conn=db, sql_code1)
dbGetQuery(conn=db, sql_code2)
```

<div class="notes">

This is what the original data looks like.

</div>


### cholestg_1_db, count of days

```{r}
sql_code1 <- 
"select day, count(day) as n_days
  from ch_table
  group by day"  
```

+ SQL code
```
`r sql_code1`
```

+ Output
```{r}
dbGetQuery(conn=db, sql_code1)
```

### Spreading across multiple columns

```{r}
sql_code1 <- 
"select d2.patient, d2.cholest as chol02, 
  d14.cholest as chol14
  from ch_table as d2
  left join ch_table as d14
  on d2.patient=d14.patient
  where d2.day=2 and d14.day=14
  limit 10
"
```

+ SQL code
```
`r sql_code1`
```

### Spreading across multiple columns

+ Output
```{r}
dbGetQuery(conn=db, sql_code1)
```

