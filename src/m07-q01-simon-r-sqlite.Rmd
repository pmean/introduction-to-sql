---
title: "Module07, Q1"
author: "Steve Simon"
output:
  pdf_document: default
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, 
    encoding=encoding,
    output_dir = "../results", 
    output_format = "all") })  
---

This file was created on 2020-07-24 and last modified on `r Sys.Date()`.

Note: this solution uses R and SQLite. An alternate solution using SAS and Oracle is also available.

Note: Some of the names used in this code are arbitrary and you can choose whatever names you want. To emphasize which names can be modified at your discretion, I am using names of famous statisticians.

The statistician being honored in this code is [Hirotugu Akaike](https://en.wikipedia.org/wiki/Hirotugu_Akaike).

Q1. Count the number of records after an inner join of acupuncture_baseline_results and acupuncture_one_year_results. Count the number of records after a left join of acupuncture_baseline_results and acupuncture_one_year_results. Why are these numbers different?

```{r hirotugu_akaike3}
library(sqldf)
akaike <- dbConnect(SQLite(),
  dbname="../data/melange.sqlite")
hirotugu3a <- dbGetQuery(conn=akaike,  "
    select count(*) as n
      from acupuncture_baseline_results as b
      join acupuncture_one_year_results as o
      on b.id=o.id
")
hirotugu3a
hirotugu3b <- dbGetQuery(conn=akaike,  "
    select count(*) as n
      from acupuncture_baseline_results as b
      left join acupuncture_one_year_results as o
      on b.id=o.id
")
hirotugu3b
dbDisconnect(conn=akaike)
```

Q2. Compute the average pk score at baseline, the average score at one year, and the average change score. Without running any formal statistical tests, tell us whether you think the pk scores are increasing, decreasing, or staying about the same.

```{r hirotugu_akaike4}
library(sqldf)
akaike <- dbConnect(SQLite(),
  dbname="../data/melange.sqlite")
hirotugu4 <- dbGetQuery(conn=akaike,  "
    select 
      avg(b.pk1) as pk1_avg,
      avg(o.pk5) as pk5_avg,
      avg(b.pk1)-avg(o.pk5) as change_score
      from acupuncture_baseline_results as b
      join acupuncture_one_year_results as o
      on b.id=o.id
")

hirotugu4
dbDisconnect(conn=akaike)
```

Q3. Display all the pk1 values for patients 64 and older.

```{r hirotugu_akaike5}
library(sqldf)
akaike <- dbConnect(SQLite(),
  dbname="../data/melange.sqlite")
hirotugu5 <- dbGetQuery(conn=akaike,  "
    select 
      d.id, d.age, b.pk1
      from acupuncture_demographics as d
      inner join acupuncture_baseline_results as b
      on d.id=b.id
      where d.age >= 64
")

hirotugu5
dbDisconnect(conn=akaike)
```

Q4. There are 100 patients with baseline values but no values at one year. Use a left join to identify these patients. Print the ids of the first ten of these patients.

```{r hirotugu_akaike6}
library(sqldf)
akaike <- dbConnect(SQLite(),
  dbname="../data/melange.sqlite")
hirotugu6 <- dbGetQuery(conn=akaike,  "
    select 
      b.id as unmatched_ids
      from acupuncture_baseline_results as b
      left join acupuncture_one_year_results as o
      on b.id=o.id
    where o.id is null
    limit 10
")

hirotugu6
dbDisconnect(conn=akaike)
```

Q5. Compute the intersection of the ids from acupuncture_baseline_results and acupuncture_one_year_results. Display the first ten rows of data only.

```{r helen_walker1}
library(sqldf)
walker <- dbConnect(SQLite(),
  dbname="../data/melange.sqlite")
helen1 <- dbGetQuery(conn=walker,  "
    select id
      from acupuncture_baseline_results
    intersect
    select id
      from acupuncture_one_year_results
    limit 10
")

helen1
dbDisconnect(conn=walker)
```

Q6. Compute the union of the ids from acupuncture_baseline_results and acupuncture_one_year_results. Display the first ten rows of data only.

```{r helen_walker2}
library(sqldf)
walker <- dbConnect(SQLite(),
  dbname="../data/melange.sqlite")
helen2 <- dbGetQuery(conn=walker,  "
    select id
      from acupuncture_baseline_results
    union
    select id
      from acupuncture_one_year_results
    order by id
    limit 10
")

helen2
dbDisconnect(conn=walker)
```

Q7. In a previous question, you were asked to list the first ten ids that were in acupuncture_baseline_results but not in acupuncture_one_year_results. Use the set operator “minus” to achieve the same goal. Note: for SQLite, use “except” instead of “minus”.

```{r helen_walker3}
library(sqldf)
walker <- dbConnect(SQLite(),
  dbname="../data/melange.sqlite")
helen3 <- dbGetQuery(conn=walker,  "
    select id
      from acupuncture_baseline_results
    except
    select id
      from acupuncture_one_year_results
    limit 10
")

helen3
dbDisconnect(conn=walker)
```

