---
title: "Simple SQL examples within R: summary statistics"
author: "Steve Simon"
date: "September 12, 2017"
output: html_document
---

SQL can produce a handful of summary statistics. It will not replace your favorite statistical package, but sometimes calculating a few of these statistics in SQL can greatly simplify your life.

We will work with the database fat.sqlite again.

```{r list-tables}
library(sqldf)
db <- dbConnect(SQLite(), dbname="../data/fat.sqlite")
dbListTables(conn=db)
```

The COUNT function is, in my opinion, one of the most useful summary functions. It allows you to quickly identify the number of records in your query. You can use COUNT on any field in your database and you should get the same answer, with one exception, which you will see in the section on NULL values.

```{r count}
fd <- dbGetQuery(conn=db,
 "SELECT COUNT(case_number) FROM fat")
fd
```

The name chosen by SQL for the result of COUNT is not a legal R name,so you would normally use the AS statement to create a better name.summary function

```{r rename-count}
fd <- dbGetQuery(conn=db, 
 "SELECT COUNT(case_number) AS case_count FROM fat")
fd
```

You can combine the COUNT function with the WHERE statement to get the number of records in a subset of your table.

```{r count-subset}
fd <- dbGetQuery(conn=db,
 "SELECT COUNT(case_number) AS subset_count FROM fat
  WHERE age >= 65")
fd
```

The max and min functions compute the largest and smallest values.

```{r max-and-min}
fd <- dbGetQuery(conn=db,
 "SELECT MAX(age) AS oldest_age FROM fat")
fd
fd <- dbGetQuery(conn=db,
 "SELECT MIN(bmi) AS lowest_bmi FROM fat")
fd
```

Two other useful summary functions are MEAN and SUM.

In all of the examples so far, the summary functions produce a table with a single row. But you can use the GROUP BY statement to get summary functions for each level of a categorical variable.

```{r group-by}
db <- dbConnect(SQLite(), dbname="../data/titanic.sqlite")
dbListTables(conn=db)
ti <- dbGetQuery(conn=db,
  "select * from ti")
ti <- dbGetQuery(conn=db,
  "select Sex, MIN(age) AS min_age from ti
  GROUP BY Sex")
dim(ti)
ti
```

You can put two or more categorical variables in the GROUP BY statement.

```{r group-by-two}
ti <- dbGetQuery(conn=db,
  "select Sex, PClass, MIN(age) AS min_age from ti
  GROUP BY Sex, PClass")
dim(ti)
ti
```

```{r shut-down-gracefully}
dbDisconnect(conn=db)
```
