---
title: "Simple SQL examples within R: input files"
author: "Steve Simon"
date: "September 12, 2017"
output: html_document
---

The emphasis in this class will be on getting information OUT of a SQL database, not getting information INTO a database. But I am showing the code here just for the sake of completeness.

There are several ways to access SQL databases in R. I'm following an example that appears at 

https://www.r-bloggers.com/r-and-sqlite-part-1/

Run this install.packages function once.

```{r install-packages, eval=FALSE}
install.packages("sqldf")
```

The sqldf package allows you to use SQL queries on an existing data frame in addition to running SQL queries on a SQL database.

When you install sqldf, you also end up installing rsqlite and dbi. 

Run the database creation steps once.

The dbConnect command will connect you to an existing database, but if the dbname argument refers to a file that has not yet been created, dbConnect will create a new SQLite database.

Normally we will focus on getting data out of a SQL database rather than getting data into a SQL database. But here's a quick example of how you might create a table in an existing database. The "official" SQL approach would use the CREATE TABLE and INSERT INTO commands, but you can combine both of these into a single function call to the dbWriteTable function.

I had to tweak the original field names slightly. The field case_number was originally called case, but case is a reserved word in sql. The fields fat_b and fat_s were originally called fat.b and fat.s, but the dot is reserved for sql queries involving multiple tables to help resolve ambiguities when some of the field names are the same across multiple tables.

```{r create a new database}
library(sqldf)
db <- dbConnect(SQLite(), dbname="../data/fat.sqlite")
dbWriteTable(conn=db, name="fat", value="../data/fat.csv",
  overwrite=TRUE, row.names=FALSE, header=TRUE)
dbDisconnect(conn=db)
```

The dbListTables function will list the names of all the tables in your database.

There is also a nice function for reading an entire table into R, dbReadTable, but I would encourage you to access the entire table using the SQL statement "select * from fat".

```{r test access}
library(sqldf)
db <- dbConnect(SQLite(), dbname="../data/fat.sqlite")
dbListTables(conn=db)
fd <- dbReadTable(conn=db, name="fat")
head(fd)
fd <- dbGetQuery(conn=db, "select * from fat")
head(fd)
dbDisconnect(conn=db)
```

This is how to read in the Titanic data set.

```{r read-titanic}
fn <- "http://www.statsci.org/data/general/titanic.txt"
ti <- read.table(file=fn, sep="\t", header=TRUE)
db <- dbConnect(SQLite(), dbname="../data/titanic.sqlite")
dbWriteTable(conn=db, name="ti", value=ti,
  overwrite=TRUE, row.names=FALSE, header=TRUE)
Survived_codes <- data.frame(code=c(0, 1), Survived_label=c("Yes", "No"))
dbWriteTable(conn=db, name="survived_codes", value=Survived_codes,
  overwrite=TRUE, row.names=FALSE, header=TRUE)
dbDisconnect(conn=db)
```

```{r test-titanic}
db <- dbConnect(SQLite(), dbname="../data/titanic.sqlite")
dbListTables(conn=db)
ti <- dbGetQuery(conn=db, "select * from ti")
head(ti)
sc <- dbGetQuery(conn=db, "select * from survived_codes")
sc
dbDisconnect(conn=db)
```

```{r pulmonary-data}
fn <- "http://www.amstat.org/publications/jse/datasets/fev.dat.txt"
pu <- read.table(file=fn)
head(pu)
db <- dbConnect(SQLite(), dbname="../data/pulmonary.sqlite")
dbWriteTable(conn=db, name="pu", value=pu,
  overwrite=TRUE, row.names=FALSE, header=TRUE)
dbDisconnect(conn=db)
```

```{r test-pulmonary}
db <- dbConnect(SQLite(), dbname="../data/pulmonary.sqlite")
dbListTables(conn=db)
pu <- dbGetQuery(conn=db, "select * from pu")
head(pu)
dbDisconnect(conn=db)
```

The two files below have the following variables:

aaup.dat.txt

* FICE (Federal ID number)
* College name
* State (postal code)
* Type  (I, IIA, or IIB)

vnames1 <- c("fice", "college", "state", "type")

* Average salary - full professors
* Average salary - associate professors
* Average salary - assistant professors
* Average salary - all ranks
* Average compensation - full professors
* Average compensation - associate professors
* Average compensation - assistant professors
* Average compensation - all ranks
* Number of full professors
* Number of associate professors
* Number of assistant professors
* Number of instructors
* Number of faculty - all ranks

vnames2 <- c("salary_full", "salary_assoc", "salary_asst", "salary_all")
vnames3 <- c("compensation_full", "compensation_assoc", "compensation_asst", "compensation_all")
vnames4 <- c("number_full", "number_assoc", "number_asst", "number_instructors", "number_all")



usnews.dat.txt

* FICE (Federal ID number)
* College name
* State (postal code)

vnames5 <- c("fice", "college", "state")

* Public/private indicator (public=1, private=2)
* Average Math SAT score
* Average Verbal SAT score
* Average Combined SAT score
* Average ACT score
* First quartile - Math SAT
* Third quartile - Math SAT
* First quartile - Verbal SAT
* Third quartile - Verbal SAT
* First quartile - ACT
* Third quartile - ACT
* Number of applications received
* Number of applicants accepted
* Number of new students enrolled
* Pct. new students from top 10% of H.S. class
* Pct. new students from top 25% of H.S. class

vnames6 <- c("support", "math_sat", "verbal_sat", "combined_sat", "act")
vnames7 <- c("avg_math_sat", "avg_verbal_sat", "avg_combined_sat", "avg_act")
vnames8 <- c("q1_math_sat", "q1_verbal_sat", "q1_combined_sat", "q1_act")
vnames9 <- c("q3_math_sat", "q3_verbal_sat", "q3_combined_sat", "q3_act")

* Number of full-time undergraduates
* Number of part-time undergraduates
* In-state tuition
* Out-of-state tuition
* Room and board costs
* Room costs
* Board costs
* Additional fees
* Estimated book costs
* Estimated personal spending
* Pct. of faculty with Ph.D.'s
* Pct. of faculty with terminal degree
* Student/faculty ratio
* Pct. alumni who donate
* Instructional expenditure per student
* Graduation rate

```{r aaup-data}
fn <- "http://ww2.amstat.org/publications/jse/datasets/aaup.dat.txt"
u1 <- read.csv(file=fn, header=FALSE, as.is=TRUE)
head(u1)
fn <- "http://ww2.amstat.org/publications/jse/datasets/usnews.dat.txt"
u2 <- read.csv(file=fn, header=FALSE, as.is=TRUE)
head(u2)
dim(u1)
dim(u2)
length(setdiff(u1$V1, u2$V1))
length(setdiff(u2$V1, u1$V1))
length(intersect(u1$V1, u2$V1))
```

```{r ctsib}
fn <- "http://www.statsci.org/data/oz/ctsibuni.txt"
ct <- read.table(file=fn, header=TRUE, as.is=TRUE)
head(ct)
tail(ct)
table(ct$Subject)
```

```{r cigarettes}
fn <- "http://jse.amstat.org/datasets/cigarettes.dat.txt"
cig <- read.table(file=fn, header=FALSE, as.is=TRUE)
names(cig) <- c("brand", "tar", "nicotine", "weight", "co")
head(cig)
db <- dbConnect(SQLite(), dbname="../data/cigarettes.sqlite")
dbWriteTable(conn=db, name="cigarettes", value=cig,
  overwrite=TRUE, row.names=FALSE, header=TRUE)
dbDisconnect(conn=db)

db <- dbConnect(SQLite(), dbname="../data/cigarettes.sqlite")
dbReadTable(db, "cigarettes")
dbDisconnect(conn=db)
write.csv(cig, "../data/cigarettes.csv", row.names=FALSE)
```

```{r airlines}
fn <- "../data/airlines.csv"
airlines <- read.csv(file=fn, header=TRUE, as.is=TRUE)
head(airlines)
db <- dbConnect(SQLite(), dbname="../data/airlines_db.sqlite")
dbWriteTable(conn=db, name="airlines_table", value=airlines,
  overwrite=TRUE, row.names=FALSE, header=TRUE)
dbDisconnect(conn=db)

db <- dbConnect(SQLite(), dbname="../data/airlines_db.sqlite")
dbReadTable(db, "airlines_table")
dbDisconnect(conn=db)
```

```{r save-everything}
save.image(file="../data/input-files.RData")
```