---
title: "Mechanics of joining/merging two tables"
author: "Suman Sahil, Steve Simon"
date: "Creation date: 2021-07-24"
output: powerpoint_presentation
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE)
suppressMessages(suppressWarnings(library(dplyr)))
suppressMessages(suppressWarnings(library(knitr)))
suppressMessages(suppressWarnings(library(magrittr)))
suppressMessages(suppressWarnings(library(sqldf)))
suppressMessages(suppressWarnings(library(tidyr)))
```

### Overview

+ Mechanics of join/merge
+ One-to-one merge
+ One-to-many merge
+ Mismatches

<div class="notes">

author: Suman Sahil, Steve Simon
date created: 2021-07-24
purpose: to show the mechanics of some simple joins
license: public domain

This talk will cover the basic mechanics of how you join data. It will use several simple artificial data sets.

</div>

### Simple example of a join/merge
+ Two tables/datasets
  + doctor_list
  + patient_list
+ Key/link
  + Defines how to match records

<div class="notes">

Here is a simple illustration of the mechanics of joining data from two tables.

</div>

### The volunteers table

```{r}
volunteer <- read.table("../data/volunteer-single.txt", sep=" ", header=FALSE)[1:8, ]
names(volunteer) <- c("v", "volunteer", "srg_yr")
volunteer
```

<div class="notes">

This is a listing of the volunteers for the first surgery by each doctor. The link variable is used to match the volunteers and the doctors.

</div>

### The doctor table

```{r}
doctor <- read.table("../data/doctor-single.txt", sep=" ", header=FALSE)
names(doctor) <- c("d", "doctor", "brth_yr")
doctor
```

<div class="notes">

This is a listing of doctors in a research database and the year that they performed their first surgery. The data is fictitious, and fans of television and the movies may recognize some of these names.

</div>

### Simple matching algorithm

+ Compare 
  + First record of volunteer table with
  + Each record of doctor table
+ Repeat for second, third, ... records of volunteer table  

<div class="notes">

The simplest matching algorithm tries to link the first record of the doctor with each record of the volunteer table. It keeps only the records that have the same value for link.

It does the same for the second record of the doctor table, the third record, and so forth.

</div>

```{r}
inner_step <- function(i) {
  volunteer %>%
    slice(i) %>%
    inner_join(doctor, by=c("v"="d")) %>%
    replace_na(list(doctor=" ")) %>%
    replace_na(list(brth_yr=" ")) %>%
    replace_na(list(volunteer=" ")) %>%
    replace_na(list(srg_yr=" ")) %>%
    mutate(d=v) %>%
    arrange(volunteer, doctor) %>%
    select(c(1:3, 6, 4:5)) %>%
    data.frame
}
outer_step <- function(i) {
  volunteer %>%
    slice(i) %>%
    full_join(doctor, by=c("v"="d")) %>%
    replace_na(list(doctor=" ")) %>%
    replace_na(list(brth_yr=" ")) %>%
    replace_na(list(volunteer=" ")) %>%
    replace_na(list(srg_yr=" ")) %>%
    mutate(d=v) %>%
    arrange(doctor) %>%
    select(c(1:3, 6, 4:5)) %>%
    data.frame
}
```

### Simple matching algorithm, step 1

```{r}
outer_step(1)
```

<div class="notes">

The first row of the volunteers table is "House" and has a linking value of 2. The matching value in the doctor table is "Laurie".

</div>

### Simple matching algorithm, first row of join

```{r}
inner_step(1)
```

<div class="notes">

This match becomes the first row of join.

</div>

### Simple matching algorithm, step 2

```{r}
outer_step(2)
```

<div class="notes">

The second row of the volunteer table is "Howser" with a linking value of 7. It matches with the "Harris" row of the doctor table.

</div>

### Simple matching algorithm, first two rows of join

```{r}
inner_step(1:2)
```

<div class="notes">

This match gets added as the second row of the join.

</div>

### Simple matching algorithm, step 3

```{r}
outer_step(3)
```

<div class="notes">

The third row of the volunteer table is "John" with a linking variable of 6. This matches with "Roberts" in the doctor table.

</div>

### Simple matching algorithm, first three rows of join

```{r}
inner_step(1:3)
```

<div class="notes">

This becomes the third row of the join.

</div>

### Simple matching algorithm, step 4

```{r}
outer_step(4)
```

<div class="notes">

The fourth row of the volunteer table is "Kildare" with a linking value of 3. It matches "Chamberlain" in the doctor table.

</div>

### Simple matching algorithm, first four rows of join

```{r}
inner_step(1:4)
```

<div class="notes">

This becomes the next row of the join.

</div>

### Simple matching algorithm, final step

```{r}
outer_step(8)
```

<div class="notes">

Jump to the last row of the volunteer table, "Welby" with a linking value of 4. It matches "Young" in the doctor table.

</div>

### Simple matching algorithm, the complete join

```{r}
inner_step(1:8)
```

<div class="notes">

The completes the join.

</div>

### An updated doctor table, one-to-many join

```{r}
doctor <- read.table("../data/doctor-multiple.txt", sep=" ", header=FALSE)
names(doctor) <- c("d", "doctor", "brth_yr")
doctor
```

<div class="notes">

This is a listing of doctors in a research database and the year that they performed their first surgery. The data is fictitious, and fans of television and the movies may recognize some of these names.

</div>

### One-to-many join, step 1

```{r}
outer_step(1)
```

<div class="notes">

The first step works just like before.

</div>

### One-to-many join, first row of join

```{r}
inner_step(1)
```

<div class="notes">

Here's the first row of our join.

</div>

### One-to-many join, step 2

```{r}
outer_step(2)
```

<div class="notes">

The second row also works the same.

</div>

### One-to-many join, first two rows of join

```{r}
inner_step(1:2)
```

<div class="notes">

Here are the first two rows.

</div>

### One-to-many join, step 3

```{r}
outer_step(3)
```

<div class="notes">

The third row is different. The volunteer "John" with a linking value of 6 matches both "Gould" and "Roberts" from the doctor table.

</div>

### One-to-many join, first four rows of join

```{r}
inner_step(1:3)
```

<div class="notes">

This adds two rows to the join table.

</div>

### One-to-many join, step 4

```{r}
outer_step(4)
```

<div class="notes">

We hit the jackpot here. The fourth row of the volunteer table, "Kildare" with a linking value of 3, matches "Ayres", "Chamberlain", "Jenkins", and "McCrea" from the doctor table.

</div>

### One-to-many join, first eight rows of join

```{r}
inner_step(1:4)
```

<div class="notes">

This adds four rows to the join.

</div>

### One-to-many join, the complete join

```{r}
inner_step(1:8)
```

<div class="notes">

Here's what the complete join looks like.

</div>

### Another update, what to do with mismatches

```{r}
volunteer <- read.table("../data/volunteer-single.txt", sep=" ", header=FALSE)
names(volunteer) <- c("v", "volunteer", "srg_yr")
volunteer
```

<div class="notes">

Let's put in a new wrinkle. Suppose there is a volunteer in this database who does not have a matchup with ANY of the doctors. The last row of this dataset is a volunter named "Who" and this "Who" does not have a matching doctor. Let's see what happens.

</div>

### Mismatched record

```{r}
outer_step(9)  %>% arrange(volunteer) -> df
df[14, 4] <- " "
df[1:13, 1] <- " "
df
```

<div class="notes">

Jump straight to the volunteer "who" with a linking value of 9. There is no match at all in the doctor table. This leaves you with two choices.

</div>


### First solution, discard the mismatch

```{r}
inner_step(1:9)
```

<div class="notes">

The first choice is to discard the mismatch. The volunteers from "House" to "Welby" are included in the join table, but "Who" is not.

</div>

### Second solution, include the mismatch 

```{r}
outer_step(1:9) %>% arrange(volunteer) -> df
df[14, 4] <- "NULL"
df[14, 5] <- "NULL"
df[14, 6] <- "NULL"
df
```

<div class="notes">

The second choice is to include the mismatch, and fill the values in the doctor table with NULLs. The choice you make depends largely on the context of the problem.

</div>

### Overview

+ Mechanics of join/merge
+ One-to-one merge
+ One-to-many merge
+ Mismatches

<div class="notes">

There's a lot more to cover. But you learned the basic algorithm for the one-to-one merge, how it works just as well for the one-to-many join, and the two approaches to handling mismatches.

</div>

